---
title: "Analysis of multiplex antibody endpoints in the MORDOR Niger trial"
subtitle: "Compare arms using MFI, seroprevalence, and SCR"
author: "Ben Arnold ben.arnold@ucsf.edu"
date: "updated: `r Sys.time()`"
output: 
  html_document:
    theme: default
    highlight: haddock
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

# Summary

Compare mean antibody levels, seroprevalence, and seroconversion rates between the placebo and biannual azithromycin arms. 

# Preamble

```{r preamble}
library(here)
here()
#----------------------------
# source the config file
#----------------------------
source(here("R","mordor-ab-Config.R"))

#----------------------------
# source the functions file
# includes reused functions
#----------------------------
source(here("R","mordor-ab-Functions.R"))
```



# Load the antibody data

```{r load antibody data}
#-------------------------------
# load the formatted analysis
# data created by
# mordor-ab-format-data.Rmd
#-------------------------------
d <- read_rds(here("data","mordor-ab-analysis.rds"))

#-------------------------------
# drop the trachoma, strongyloides, 
# and GST negative control values
#-------------------------------
d2 <- d %>%
  filter(!antigen %in% c("pgp3","ct694","nie","gst")) %>%
  mutate(antigenf = factor(antigenf))

#-------------------------------
# drop baseline measurements
#-------------------------------
d2 <- d2 %>%
  filter(phase > 0)


#-------------------------------
# age restrictions based on 
# age-antibody curves
# to exclude ages without any
# variation in antibody levels
# (esp. enterics, which become saturated)
#
# Enterics + strep: 6 mo - 24
# (except for salmonella)
#
# Malaria antigens: 12 - 59 mo
#-------------------------------
d2 <- d2 %>%
  filter(agem >= 6) %>%
  mutate(agedrop = case_when(
    antigen %in% c("cp17","cp23","vsp3","vsp5","p18","p39","etec","ctb","speb") & (agem > 24) ~ 1,
    antigen %in% c("hrp2","csp","glurp","lsa1","ama","pfmsp1","pvmsp1","pomsp1","pmmsp1") & (agem < 12) ~ 1,
    TRUE ~ 0
  )
         ) %>%
  filter(agedrop == 0)

```

# Create composite seropositivity indicators

For enteric pathogens with multiple antigens (Cryptosporidium, Giardia, Salmonella, Campylobacter), create a series of seropositivity indicators that indicate if a child was positive to either antigen.

Then bind those to the original data frame to create a seropositivity dataset for analyses.

```{r composite seropositivity indicators}
d_enteric_comps <- d2 %>%
  filter(pathogen %in% c("Cryptosporidium","Giardia","Salmonella","Campylobacter")) %>%
  group_by(pathogen,childid,phase) %>%
  mutate(seropos = max(seropos)) %>%
  slice(1) %>%
  mutate(antigenf = case_when(
    antigen %in% c("cp17","cp23") ~ "Cryptosporidium Cp17 or Cp23",
    antigen %in% c("vsp3","vsp5") ~ "Giardia VSP-3 or VSP-5",
    antigen %in% c("salb","sald") ~ "Salmonella LPS B or D",
    antigen %in% c("p18","p39") ~ "Campylobacter p18 or p39"
  )) %>%
  select(clusterid,phase,arm,childid,agem,sex,dbsid,pathogen,antigenf,seropos)


```

```{r create seropositivity dataset, warning=FALSE}
d_serop <- d2 %>%
  # drop pathogens w/ composite indicators
  filter(!pathogen %in% c("Cryptosporidium","Giardia","Salmonella","Campylobacter")) %>%
  # add composite indicators
  bind_rows(d_enteric_comps) %>%
  # create new factor levels that includes composite indicators
  mutate(antigenf = factor(antigenf,levels = c(
    "Campylobacter p18 or p39",
    "ETEC LTB",
    "Cholera CTB",
    "Salmonella LPS B or D",
    "Cryptosporidium Cp17 or Cp23",
    "Giardia VSP-3 or VSP-5",
   levels(d2$antigenf)[11:20]) )
         ) %>%
  # drop extra variables (MFI doesn't correspond to composite seropos so drop)
  dplyr::select(-mfi,-logmfi,-agedrop)

```

# Estimate mean mfi by arm

```{r means by arm}
#-----------------------------
# tally number of observations
# by antigen
#-----------------------------
n_mfi <- d2 %>%
  group_by(pathogen,antigenf,arm) %>%
  mutate(nomiss = ifelse(!is.na(logmfi),1,0)) %>%
  summarize(nobs = sum(nomiss)) %>%
  pivot_wider(id_cols = c(pathogen, antigenf), names_from = "arm", values_from = nobs) %>%
  rename(control_n = sun,
         azithro_n = moon)


#-----------------------------
# estimate means by arm
# and difference in means
#-----------------------------
mu_mfi <- d2 %>%
  group_by(pathogen,antigenf,arm) %>%
  summarize(mean_mfi = mean(logmfi)) %>%
  pivot_wider(id_cols = c(pathogen, antigenf), names_from = "arm", values_from = mean_mfi) %>%
  rename(control = sun,
         azithro = moon) %>%
  mutate(diff = azithro - control)

#-----------------------------
# merge means onto the Ns
#-----------------------------
mu_mfi <- left_join(n_mfi, mu_mfi, by=c("pathogen","antigenf"))
```

```{r bootstrap mean MFI diff}
#-----------------------------
# bootstrap resample communities
# with replacement to estimate
# 95% CIs for difference in means
#-----------------------------
set.seed(123)
nreps <- 1000
ncl <- length(unique(d2$clusterid))
bsamp <- matrix(sample(unique(d2$clusterid),size = ncl*nreps, replace = TRUE),nrow = ncl,ncol = nreps)
d_mfi_boot <- d2 %>% select(clusterid,antigenf,arm,logmfi)
mu_mfi_boot <- foreach(bi = 1:nreps, .combine = rbind) %do% {
  
  if(bi %% 50 == 0) cat(bi,"\n") else cat(".")

  di <- left_join(data.frame(clusterid = bsamp[,bi], stringsAsFactors = FALSE),
                  d_mfi_boot, by = "clusterid")
  di %>%
  group_by(antigenf,arm) %>%
  summarize(mean_mfi = mean(logmfi)) %>%
  pivot_wider(id_cols = "antigenf", names_from = "arm", values_from = mean_mfi) %>%
  rename(control = sun,
         azithro = moon) %>%
  mutate(diff = azithro - control, 
         bootrep = bi)
  
}
```

```{r mean mfi bootstrap cis}
#-----------------------------
# calculate percentile 95%
# CIs from the bootstrap
# distribution merge to estimates
#-----------------------------
mu_mfi_ci <- mu_mfi_boot %>%
  group_by(antigenf) %>%
  mutate(mean_c_lb = quantile(control, probs = 0.025),
         mean_c_ub = quantile(control, probs = 0.975),
         mean_a_lb = quantile(azithro, probs = 0.025),
         mean_a_ub = quantile(azithro, probs = 0.975),
         diff_bmean = mean(diff),
         diff_bse = sd(diff),
         diff_lb = quantile(diff, probs = 0.025),
         diff_ub = quantile(diff, probs = 0.975)) %>%
  select(antigenf,starts_with("mean_"), starts_with("diff_")) %>%
  slice(1)
  
mu_mfi2 <- mu_mfi %>%
  left_join(mu_mfi_ci, by = "antigenf")
  
```

```{r permutation p-values}
#-----------------------------
# estimate permutation p-values
# for the difference in means
#
# pooling over phase 6+
#
# conduct the permutation
# test on unweighted cluster
# level means
#-----------------------------
clmeans_mfi <- d2 %>% 
    group_by(clusterid,arm,pathogen,antigenf) %>%
    summarize(mean_mfi = mean(logmfi))

set.seed(87592)
permute_mfi <- foreach(abi = levels(d2$antigenf), .combine = rbind) %do% {
  di <- clmeans_mfi %>% filter(antigenf == abi)
  pti <- oneway_test(mean_mfi ~ arm, data= clmeans_mfi,subset = clmeans_mfi$antigenf==abi, distribution = "exact", alternative = "two.sided")
  data.frame(antigenf = abi, permute_p = pvalue(pti))
  }

```

## Table of results
```{r MFI means table}
mu_mfi_table <- mu_mfi2 %>%
  ungroup() %>%
  left_join(permute_mfi, by = "antigenf") %>%
  mutate(diff_ci = paste0(sprintf("%1.3f",diff)," (",sprintf("%1.3f",diff_lb),", ", sprintf("%1.3f",diff_ub),")")) %>%
  select(antigenf, control, azithro, diff_ci, permute_p)

knitr::kable(mu_mfi_table,
             col.names = c("Pathogen, antigen", "Placebo","Azithro.","Difference (95% CI)","P-value*"), 
             digits = 3,
             align = "lcccc") %>%
  kable_styling(bootstrap_options = c("striped","condensed"),full_width = TRUE) %>%
  add_header_above(c(" " = 1, "Mean log10\nLuminex Response (MFI-bg)" = 2,  " " = 2)) %>%
  kableExtra::group_rows(group_label = "Enterics and strep", start_row = 1, end_row = 11) %>%
  kableExtra::group_rows(group_label = "Malaria", start_row = 12, end_row = 20) %>%
  footnote(
    symbol=c("Exact permutation P-value.")
  )

```

## Figure of results

```{r MFI means figure}
#------------------------------
# plot mean log10 MFI by arm
#------------------------------

# make some labels
d_labels <- data.frame(group = rep("enterics\nand\nstrep",2),
                       antigenf=rep("Campylobacter p18",2),
                       arm = c("azithromycin","placebo"),
                       mean = rep(3.5,2))

# format the output for plotting
mu_mfi_control <- mu_mfi2 %>%
  ungroup() %>%
  select(pathogen,antigenf,mean = control, mean_lb = mean_c_lb, mean_ub = mean_c_ub) %>%
  mutate(arm = "placebo")
mu_mfi_azithro <- mu_mfi2 %>%
  ungroup() %>%
  select(pathogen,antigenf,mean = azithro, mean_lb = mean_a_lb, mean_ub = mean_a_ub) %>%
  mutate(arm = "azithromycin")

mu_mfi_plot <- bind_rows(mu_mfi_control,mu_mfi_azithro) %>%
  mutate(antigenf = factor(antigenf, levels = rev(levels(mu_mfi2$antigenf)))) %>%
  arrange(antigenf)
mu_mfi_plot$group = "enterics\nand\nstrep"
mu_mfi_plot$group[grep("P. ",mu_mfi_plot$pathogen)] <- "malaria"
  
# make figure
pcols <- c(vircols[3],cbpal[2])
plot_mfi_means <- ggplot(data = mu_mfi_plot, aes(x = antigenf, color = arm)) +
  facet_grid(group~., scales = "free_y") +
  # plot points
  geom_errorbar(aes(ymin = mean_lb, ymax = mean_ub),width = 0.4, alpha=0.8,
                position = position_nudge(x = rep(c(-0.2,0.2),20))) +
  geom_point(aes(y = mean), alpha=0.8,
             position = position_nudge(x = rep(c(-0.2,0.2),20)) ) +
  
  scale_color_manual(values = pcols) +
  # add annotation and labels
  geom_text(data=d_labels, aes(x = antigenf, y = mean, label=arm), position = position_nudge(x = c(0.3,-0.3) ), size = 3, hjust = 1 ) +
  labs(x = "antigen", y = "mean log10 Luminex response\n(MFI-bg)", tag = "A") +
  
  # figure layout
  coord_flip() +
  # theme_minimal() +
  theme(
    legend.position = "none",
    strip.text.y = element_text(angle = 0)
  )

```

```{r MFI diff figure}
#------------------------------
# plot the difference between
# arms (companion to the means)
#------------------------------

# format the output for plotting
mu_mfi_plot2 <- mu_mfi2 %>%
  ungroup() %>%
  mutate(antigenf = factor(antigenf, levels = rev(levels(mu_mfi2$antigenf))))
mu_mfi_plot2$group = "enterics\nand\nstrep"
mu_mfi_plot2$group[grep("P. ",mu_mfi_plot2$pathogen)] <- "malaria"

# make the figure
plot_mfi_diff <- ggplot(data = mu_mfi_plot2, aes(x = antigenf, y = diff)) +
  facet_grid(group~., scales = "free_y") +
  geom_hline(yintercept = 0, color = "gray60") +
  geom_errorbar(aes(ymin = diff_lb, ymax = diff_ub),width = 0.4,alpha=0.6) +
  geom_point(alpha=0.6) +
  scale_color_manual(values = pcols) +
  labs(x = NULL, y = "difference in log10 Luminex response (MFI-bg)\nazithromycin - placebo", tag = "B") +
  coord_flip() +
  # theme_minimal() +
  theme(
    legend.position = "none",
    strip.text.y = element_text(angle = 0)
  )


  
```

```{r mfi composite figure, fig.width = 10, fig.height = 6}
plot_mfi_comp <- grid.arrange(plot_mfi_means,plot_mfi_diff,ncol=2,nrow=1, widths = c(4,4))

ggsave(here("figures","mordor-ab-diff-mfi.png"),plot_mfi_comp,device = "png",width = 10, height = 6)
```

# Seroprevalence


```{r seroprev by arm}

#-----------------------------
# tally number of observations
# by antigen (including composites)
#-----------------------------
n_serop <- d_serop %>%
  group_by(pathogen,antigenf,arm) %>%
  mutate(nomiss = ifelse(!is.na(seropos),1,0)) %>%
  summarize(nobs = sum(nomiss)) %>%
  pivot_wider(id_cols = c(pathogen, antigenf), names_from = "arm", values_from = nobs) %>%
  rename(control_n = sun,
         azithro_n = moon)

#-----------------------------
# estimate seroprevalence by arm
# and difference in seroprevalence
#-----------------------------
mu_serop <- d_serop %>%
  group_by(pathogen,antigenf,arm) %>%
  summarize(mean_serop = mean(seropos)) %>%
  pivot_wider(id_cols = c(pathogen, antigenf), names_from = "arm", values_from = mean_serop) %>%
  rename(control = sun,
         azithro = moon) %>%
  mutate(diff = azithro - control)

#-----------------------------
# merge means onto the Ns
#-----------------------------
mu_serop <- left_join(n_serop, mu_serop, by=c("pathogen","antigenf"))
```


```{r bootstrap mean seropos diff}
#-----------------------------
# bootstrap resample communities
# with replacement to estimate
# 95% CIs for difference in seroprev
#-----------------------------
set.seed(123)
nreps <- 1000
ncl <- length(unique(d_serop$clusterid))
bsamp <- matrix(sample(unique(d_serop$clusterid),size = ncl*nreps, replace = TRUE),nrow = ncl,ncol = nreps)
d_serop_boot <- d_serop %>% select(clusterid,antigenf,arm,seropos)
mu_serop_boot <- foreach(bi = 1:nreps, .combine = rbind) %do% {
  
  if(bi %% 50 == 0) cat(bi,"\n") else cat(".")
  
  di <- left_join(data.frame(clusterid = bsamp[,bi], stringsAsFactors = FALSE),
                  d_serop_boot, by = "clusterid")
  di %>%
  group_by(antigenf,arm) %>%
  summarize(mean_serop = mean(seropos)) %>%
  pivot_wider(id_cols = "antigenf", names_from = "arm", values_from = mean_serop) %>%
  rename(control = sun,
         azithro = moon) %>%
  mutate(diff = azithro - control, 
         bootrep = bi)

}
```


```{r mean seroprev bootstrap cis}
#-----------------------------
# calculate percentile 95%
# CIs from the bootstrap
# distribution merge to estimates
#-----------------------------
mu_serop_ci <- mu_serop_boot %>%
  group_by(antigenf) %>%
  mutate(mean_c_lb = quantile(control, probs = 0.025),
         mean_c_ub = quantile(control, probs = 0.975),
         mean_a_lb = quantile(azithro, probs = 0.025),
         mean_a_ub = quantile(azithro, probs = 0.975),
         diff_bmean = mean(diff),
         diff_bse = sd(diff),
         diff_lb = quantile(diff, probs = 0.025),
         diff_ub = quantile(diff, probs = 0.975)) %>%
  select(antigenf,starts_with("mean_"), starts_with("diff_")) %>%
  slice(1)
  
mu_serop2 <- mu_serop %>%
  left_join(mu_serop_ci, by = "antigenf")
  
```


```{r permutation p-values seroprev}
#-----------------------------
# estimate permutation p-values
# for the difference in seroprev
#
# pooling over phase 6+
#
# conduct the permutation
# test on unweighted cluster
# level means
#-----------------------------
clmeans_serop <- d_serop %>% 
    group_by(clusterid,arm,pathogen,antigenf) %>%
    summarize(mean_serop = mean(seropos))

set.seed(34527)
permute_serop <- foreach(abi = levels(d_serop$antigenf), .combine = rbind) %do% {
  di <- clmeans_serop %>% filter(antigenf == abi)
  pti <- oneway_test(mean_serop ~ arm, data= clmeans_serop,subset = clmeans_serop$antigenf==abi, distribution = "exact", alternative = "two.sided")
  data.frame(antigenf = abi, permute_p = pvalue(pti))
  }

```


## Table of results
```{r seroprev means table}
mu_serop_table <- mu_serop2 %>%
  ungroup() %>%
  left_join(permute_serop, by = "antigenf") %>%
  mutate(diff_ci = paste0(sprintf("%1.2f",diff)," (",sprintf("%1.2f",diff_lb),", ", sprintf("%1.2f",diff_ub),")")) %>%
  select(antigenf,control, azithro, diff_ci, permute_p)

knitr::kable(mu_serop_table,
             col.names = c("Pathogen, antigen", "Placebo","Azithromycin","Difference (95% CI)","P-value*"), 
             digits = c(0,2,2,0,3),
             align = "lcccc") %>%
  kable_styling(bootstrap_options = c("striped","condensed"),full_width = TRUE) %>%
  add_header_above(c(" " = 1, "Proportion\nSeropositive" = 2,  " " = 2)) %>%
  kableExtra::group_rows(group_label = "Enterics and strep", start_row = 1, end_row = 7) %>%
  kableExtra::group_rows(group_label = "Malaria", start_row = 8, end_row = 16) %>%
  footnote(
    symbol=c("Exact permutation P-value.")
  )

```



## Figure of results

```{r seroprev figure}
#------------------------------
# plot seroprevalence by arm
#------------------------------

# make some labels
d_labels <- data.frame(group = rep("enterics\nand\nstrep",2),
                       antigenf=rep("Campylobacter p18 or p39",2),
                       arm = c("azithromycin","placebo"),
                       mean = rep(0.85,2))

# format the output for plotting
mu_serop_control <- mu_serop2 %>%
  ungroup() %>%
  select(pathogen,antigenf,mean = control, mean_lb = mean_c_lb, mean_ub = mean_c_ub) %>%
  mutate(arm = "placebo")
mu_serop_azithro <- mu_serop2 %>%
  ungroup() %>%
  select(pathogen,antigenf,mean = azithro, mean_lb = mean_a_lb, mean_ub = mean_a_ub) %>%
  mutate(arm = "azithromycin")

mu_serop_plot <- bind_rows(mu_serop_control,mu_serop_azithro) %>%
  mutate(antigenf = factor(antigenf, levels = rev(levels(mu_serop2$antigenf)))) %>%
  arrange(antigenf)
mu_serop_plot$group = "enterics\nand\nstrep"
mu_serop_plot$group[grep("P. ",mu_serop_plot$pathogen)] <- "malaria"
  
# make figure
pcols <- c(vircols[3],cbpal[2])
plot_serop_means <- ggplot(data = mu_serop_plot, aes(x = antigenf, color = arm)) +
  facet_grid(group~., scales = "free_y") +
  # plot points
  geom_errorbar(aes(ymin = mean_lb, ymax = mean_ub),width = 0.4, alpha=0.8,
                position = position_nudge(x = rep(c(-0.2,0.2),20))) +
  geom_point(aes(y = mean), alpha=0.8,
             position = position_nudge(x = rep(c(-0.2,0.2),20)) ) +
  
  scale_color_manual(values = pcols) +
  scale_y_continuous(breaks = seq(0,1,by=0.2), labels=sprintf("%1.0f",seq(0,1,by=0.2)*100)) +
  # add annotation and labels
  geom_text(data=d_labels, aes(x = antigenf, y = mean, label=arm), position = position_nudge(x = c(0.2,-0.2) ), size = 3, hjust = 1 ) +
  labs(x = "antigen", y = "seroprevalence (%)\n ", tag = "A") +
  
  # figure layout
  coord_flip(ylim=c(0,1)) +
  # theme_minimal() +
  theme(
    legend.position = "none",
    strip.text.y = element_text(angle = 0)
  )

```

```{r seroprev diff figure}
#------------------------------
# plot the difference between
# arms (companion to the means)
#------------------------------

# format the output for plotting
mu_serop_plot2 <- mu_serop2 %>%
  ungroup() %>%
  mutate(antigenf = factor(antigenf, levels = rev(levels(mu_serop2$antigenf))))
mu_serop_plot2$group = "enterics\nand\nstrep"
mu_serop_plot2$group[grep("P. ",mu_serop_plot2$pathogen)] <- "malaria"

# make the figure
plot_serop_diff <- ggplot(data = mu_serop_plot2, aes(x = antigenf, y = diff)) +
  facet_grid(group~., scales = "free_y") +
  geom_hline(yintercept = 0, color = "gray60") +
  geom_errorbar(aes(ymin = diff_lb, ymax = diff_ub),width = 0.4,alpha=0.6) +
  geom_point(alpha=0.6) +
  scale_color_manual(values = pcols) +
  scale_y_continuous(breaks = seq(-0.15,0.1,by=0.05), labels=sprintf("%1.0f",seq(-0.15,0.1,by=0.05)*100)) +
  labs(x = NULL, y = "difference in seroprevalence (%)\nazithromycin - placebo", tag = "B") +
  coord_flip() +
  # theme_minimal() +
  theme(
    legend.position = "none",
    strip.text.y = element_text(angle = 0)
  )


  
```

```{r serop composite figure, fig.width = 10, fig.height = 6}
plot_serop_comp <- grid.arrange(plot_serop_means,plot_serop_diff,ncol=2,nrow=1, widths = c(4,4))

ggsave(here("figures","mordor-ab-diff-seroprev.png"),plot_serop_comp,device = "png",width = 10, height = 5)
```

# Force of infection by arm

Estimate serological force of infection through the seroconverion rate. Estimate the seroconversion rate from age-structured seroprevalence.

We use a generalized linear model with a complementary log-log link fit with current status, age-prevalence data, equivalent to a proportional hazards model. We model the baseline hazard in age using a semi-parametric, cubic spline, $g(\cdot)$, and include a binary indicator for treatment group. Let $A$ be a child's age and let $T$ be a binary indicator for azithromycin treatment. The model is:

\begin{equation}
  \log - \log(1-P(Y|A,T)) = g(A) + \beta X
\end{equation}


The hazard or force of infection at age $a$ is: $\lambda(a) = F'(a)/(1-F(a))$. From the definition of the hazard, we have: 

$1- F(a) = \exp [ - \int_0^a \lambda(a) da ]$ and $\int_0^a \lambda(a) da = - \log [1-F(a)]$.

This is the cumulative hazard. The average hazard per year (units of $a$) also divided $-\log[1-F(a)]$ by $a$.  So, all of the information is embedded in the cumulative distribution function, $F(a)$, which here is the age-dependent seroprevalence curve. 

The average hazard over the age period $a_1$ to $a_2$ is:

\begin{equation}
  \int_{a_1}^{a_2} \lambda(a) da = \frac{\log[1-F(a_1)]-\log[1-F(a_2)]}{a_2 - a_1}
\end{equation}

Limit the force of infection analysis to pathogens with some evidence for seroprevalence > 0.

```{r FOI  estimates}

d_foi <- d_serop %>%
  filter(antigenf %in% c(
    "Campylobacter p18 or p39",
    "ETEC LTB",
    "Cholera CTB",
    "Salmonella LPS B or D",
    "Cryptosporidium Cp17 or Cp23",
    "Giardia VSP-3 or VSP-5",
    "Streptococcus A",
    "P. falciparum MSP-1",
    "P. falciparum AMA",
    "P. falciparum GLURP-Ro",
    "P. falciparum LSA1",
    "P. malariae MSP-1"
  )
         ) %>%
  mutate(antigenf = droplevels(antigenf))

set.seed(123)
foi_ests <- foreach(ab=levels(d_foi$antigenf),.combine=rbind) %do% {
  
    pd <- filter(d_foi, antigenf==ab)
    gfit <- gam(seropos ~ s(agem, bs="cr") + arm , 
                data=pd,
                family=binomial(link="cloglog"))
    gsum <- summary(gfit)
    # estimate average seroconversion rate by arm
    newd0 <- data.frame(agem=c(min(pd$agem),max(pd$agem)), arm = "sun")
    newd1 <- data.frame(agem=c(min(pd$agem),max(pd$agem)), arm = "moon")
    lambda0 <- avgFOI(gfit, newdata=newd0, a1=min(pd$agem),a2=max(pd$agem),nreps=2)$mufoi
    lambda1 <- avgFOI(gfit, newdata=newd1, a1=min(pd$agem),a2=max(pd$agem),nreps=2)$mufoi
    # estimate HR from the model 
    hr <- as.numeric(exp(gfit$coefficients[2]))
    # estimate bootstrapped 95% CI
    clids <- unique(pd$clusterid)
    breps <- 1000
    bsamp <- matrix(sample(clids,size=breps*length(clids),replace=TRUE),nrow=length(clids),ncol=breps)
    boot_lambda0s <- rep(NA,breps)
    boot_lambda1s <- rep(NA,breps)
    boot_hrs <- rep(NA,breps)
    for(i in 1:breps) {
      di <- data.frame(clusterid = bsamp[,i],stringsAsFactors = FALSE) %>% left_join(pd,by="clusterid")
      bfit <- gam(seropos ~ s(agem, bs="cr") + arm ,
                  data=di,
                  family=binomial(link="cloglog")
                  )
      newd0i <- data.frame(agem=c(min(di$agem),max(di$agem)), arm = "sun")
      newd1i <- data.frame(agem=c(min(di$agem),max(di$agem)), arm = "moon")
      boot_lambda0s[i] <- avgFOI(bfit, newdata=newd0i, a1=min(di$agem),a2=max(di$agem),nreps=2)$mufoi
      boot_lambda1s[i] <- avgFOI(bfit, newdata=newd1i, a1=min(di$agem),a2=max(di$agem),nreps=2)$mufoi
      boot_hrs[i] <- as.numeric(exp(bfit$coefficients[2]))
    }
    
    # return results
    res <- data.frame(antigenf=ab, 
                      lambda0=lambda0,
                      lambda0_min95 = quantile(boot_lambda0s,probs=0.025),
                      lambda0_max95 = quantile(boot_lambda0s,probs=0.975),
                      lambda1=lambda1,
                      lambda1_min95 = quantile(boot_lambda1s,probs=0.025),
                      lambda1_max95 = quantile(boot_lambda1s,probs=0.975),
                      hr = hr,
                      hr_min95 = quantile(boot_hrs,probs=0.025),
                      hr_max95 = quantile(boot_hrs,probs=0.975)
                      )
    res
}

foi_ests_tab <- foi_ests %>%
  mutate(lambda0c = paste0(sprintf("%1.2f",lambda0*12)," (",
                            sprintf("%1.2f",lambda0_min95*12),", ", 
                            sprintf("%1.2f",lambda0_max95*12),")"),
         lambda1c = paste0(sprintf("%1.2f",lambda1*12)," (", 
                            sprintf("%1.2f",lambda1_min95*12),", ", 
                            sprintf("%1.2f",lambda1_max95*12),")"),
         hrc = paste0(sprintf("%1.2f",hr)," (",
                       sprintf("%1.2f",hr_min95),", ",
                       sprintf("%1.2f",hr_max95),")")
         )

knitr::kable(foi_ests_tab %>% select(antigenf,lambda0c,lambda1c,hrc),digits=3,
             caption="Average seroconversion rate (SCR) per year estimated from age-structured seroprevalence",
             align = "lccc",
             col.names = c("Antigens","Placebo SCR (95% CI)","Azithromycin SCR (95% CI)", "HR (95% CI)"),
             row.names = FALSE)  %>%
  kable_styling(bootstrap_options = "striped",full_width = TRUE)

```

```{r foi ests figure}
#------------------------------
# plot SCR by arm
# estimates are multiplied by
# 12 to convert from per-month
# to per-year
#------------------------------

# make some labels
d_labels <- data.frame(group = rep("enterics\nand\nstrep",2),
                       antigenf=rep("Campylobacter p18 or p39",2),
                       arm = c("azithromycin","placebo"),
                       mean = rep(4,2))

# format the output for plotting
mu_scr_control <- foi_ests %>%
  ungroup() %>%
  select(antigenf,mean = lambda0, mean_lb = lambda0_min95, mean_ub = lambda0_max95) %>%
  mutate(arm = "placebo")
mu_scr_azithro <- foi_ests %>%
  ungroup() %>%
  select(antigenf,mean = lambda1, mean_lb = lambda1_min95, mean_ub = lambda1_max95) %>%
  mutate(arm = "azithromycin")

mu_scr_plot <- bind_rows(mu_scr_control,mu_scr_azithro) %>%
  mutate(antigenf = factor(antigenf, levels = rev(levels(d_foi$antigenf)))) %>%
  arrange(antigenf)
mu_scr_plot$group = "enterics\nand\nstrep"
mu_scr_plot$group[substr(as.character(mu_scr_plot$antigenf),1,3)=="P. "] <- "malaria"
  
# make figure
pcols <- c(vircols[3],cbpal[2])
plot_scr_means <- ggplot(data = mu_scr_plot, aes(x = antigenf, color = arm)) +
  facet_grid(group~., scales = "free_y") +
  # plot points
  geom_errorbar(aes(ymin = 12*mean_lb, ymax = 12*mean_ub),width = 0.4, alpha=0.8,
                position = position_nudge(x = rep(c(-0.2,0.2),20))) +
  geom_point(aes(y = 12*mean), alpha=0.8,
             position = position_nudge(x = rep(c(-0.2,0.2),20)) ) +
  
  scale_color_manual(values = pcols) +
  scale_y_continuous(breaks = seq(0,4,by=1)) +
  # add annotation and labels
  geom_text(data=d_labels, aes(x = antigenf, y = mean, label=arm), position = position_nudge(x = c(0.2,-0.2) ), size = 3, hjust = 1 ) +
  labs(x = "antigen", y = "force of infection\n(seroconversion rate per child-year)", tag = "A") +
  
  # figure layout
  coord_flip(ylim=c(0,4)) +
  # theme_minimal() +
  theme(
    legend.position = "none",
    strip.text.y = element_text(angle = 0)
  )

```

```{r scr hazard ratio figure}
#------------------------------
# plot the hazard ratio between
# arms (companion to the means)
#------------------------------

# format the output for plotting
mu_scr_plot2 <- foi_ests %>%
  ungroup() %>%
  mutate(antigenf = factor(antigenf, levels = rev(levels(d_foi$antigenf))))
mu_scr_plot2$group = "enterics\nand\nstrep"
mu_scr_plot2$group[substr(as.character(mu_scr_plot2$antigenf),1,3)=="P. "] <- "malaria"

# make the figure
plot_scr_hr <- ggplot(data = mu_scr_plot2, aes(x = antigenf, y = hr)) +
  facet_grid(group~., scales = "free_y") +
  geom_hline(yintercept = 1, color = "gray60") +
  geom_errorbar(aes(ymin = hr_min95, ymax = hr_max95),width = 0.4,alpha=0.6) +
  geom_point(alpha=0.6) +
  scale_color_manual(values = pcols) +
  scale_y_continuous(breaks = c(0.5,0.8,1,1.2,1.5,2,3),trans = "log") +
  labs(x = NULL, y = "hazard ratio \nazithromycin / placebo", tag = "B") +
  coord_flip(ylim=c(0.5,3)) +
  # theme_minimal() +
  theme(
    legend.position = "none",
    strip.text.y = element_text(angle = 0),
    panel.grid.minor = element_blank()
  )


  
```


```{r scr composite figure, fig.width = 10, fig.height = 6}
plot_scr_comp <- grid.arrange(plot_scr_means,plot_scr_hr,ncol=2,nrow=1, widths = c(4,4))

ggsave(here("figures","mordor-ab-scr-hr.png"),plot_scr_comp,device = "png",width = 10, height = 5)
```

# Session Info
```{r session info}
sessionInfo()
```


