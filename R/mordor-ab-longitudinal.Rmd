---
title: "Analysis of multiplex antibody endpoints in the MORDOR Niger trial"
subtitle: "Longitudinal estimates of seroconversion"
author: "Ben Arnold ben.arnold@ucsf.edu"
date: "updated: `r Sys.time()`"
output: 
  html_document:
    theme: default
    highlight: haddock
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

# Summary

Estimate prospective seroconversion rates among children measured longitudinally. Assume that events ocurred at the midpoint of the interval, consistent with the mortality outcome measurement and with past longitudinal analyses of enteric seronconversion.

Keenan, J. D., Bailey, R. L., West, S. K., Arzika, A. M., Hart, J., Weaver, J., Kalua, K., Mrango, Z., Ray, K. J., Cook, C., Lebas, E., O’Brien, K. S., Emerson, P. M., Porco, T. C., Lietman, T. M. & MORDOR Study Group. Azithromycin to Reduce Childhood Mortality in Sub-Saharan Africa. _N. Engl. J. Med._ 378, 1583–1592 (2018). https://pubmed.ncbi.nlm.nih.gov/29694816/

Arnold, B. F., Martin, D. L., Juma, J., Mkocha, H., Ochieng, J. B., Cooley, G. M., Omore, R., Goodhew, E. B., Morris, J. F., Costantini, V., Vinjé, J., Lammie, P. J. & Priest, J. W. Enteropathogen antibody dynamics and force of infection among children in low-resource settings. _eLife_ 8, (2019). https://pubmed.ncbi.nlm.nih.gov/31424386/

# Preamble

```{r preamble}
library(here)
here()
#----------------------------
# source the config file
#----------------------------
source(here("R","mordor-ab-Config.R"))

#----------------------------
# source the functions file
# includes reused functions
#----------------------------
source(here("R","mordor-ab-Functions.R"))
```



# Load the antibody data

```{r load antibody data}
#-------------------------------
# load the formatted analysis
# data created by
# mordor-ab-format-data.Rmd
#-------------------------------
d <- read_rds(here("data","mordor-ab-analysis.rds"))

#-------------------------------
# drop the trachoma, strongyloides, 
# and GST negative control values
#-------------------------------
d2 <- d %>%
  filter(!antigen %in% c("pgp3","ct694","nie","gst")) %>%
  mutate(antigenf = factor(antigenf))

#-------------------------------
# age restrictions based on 
# age-antibody curves
# to exclude ages without any
# variation in antibody levels
# 
# For enterics, limit from birth
# to 24 months.
#
# (except for salmonella, strep A, birth to 59 mo)
#
# Malaria antigens: 12 - 59 mo
#-------------------------------
d2 <- d2 %>%
  mutate(agedrop = case_when(
    antigen %in% c("cp17","cp23","vsp3","vsp5","p18","p39","etec","ctb") & (agem > 24) ~ 1,
    antigen %in% c("hrp2","csp","glurp","lsa1","ama","pfmsp1","pvmsp1","pomsp1","pmmsp1") & (agem < 12) ~ 1,
    TRUE ~ 0
  )
         ) %>%
  filter(agedrop == 0)

```

# Identify children measured longitudinally

Identify children without longitudinal measurements. Tally them, then exclude them.

```{r identify longitudinal children}

#-------------------------------
# identify the number of observations
# for each child
#-------------------------------
d_nolong <- d2 %>%
  group_by(antigenf,childid) %>%
  arrange(phase) %>%
  mutate(nobs = n())

#-------------------------------
# print number of children with 
# different numbers of measurements
# for enterics (6-24 mos) and malaria (12-59 mos)
#-------------------------------
table(d_nolong$nobs[d_nolong$antigen=="etec"])/1:4
table(d_nolong$nobs[d_nolong$antigen=="ama"])/1:5

#-------------------------------
# print number of observations 
# excluded by outcome
#-------------------------------
table(d_nolong$antigenf,d_nolong$nobs>1)

#-------------------------------
# restrict to children with >1 obs
#-------------------------------
dl <- d_nolong %>%
  filter(nobs>1) %>%
  arrange(antigenf,childid,phase) %>%
  mutate(phase_diff = phase - lag(phase))

table(dl$antigenf,dl$phase_diff)

#-----------------------------
# inspect children who have
# negative age differences
# between visits
# there appear to be 115
# children whose age difference
# was <=0 between phases
# this appears to be a data
# error. Drop them from the
# longitudinal analysis
#-----------------------------
dl <- dl %>%
  group_by(antigenf,childid) %>%
  arrange(antigenf, childid,phase) %>%
  mutate(age_diff = agem - lag(agem),
         min_agediff = min(age_diff, na.rm = TRUE))
length(unique(dl$childid[dl$min_agediff<=0]))
dl <- dl %>%
  filter(min_agediff >0) %>%
  select(-age_diff,-min_agediff)

#-------------------------------
# print final number of children with 
# different numbers of measurements
# for enterics (6-24 mos) and malaria (12-59 mos)
#-------------------------------
table(dl$nobs[dl$antigen=="etec"])/2:4
table(dl$nobs[dl$antigen=="ama"])/2:5


```

# Create composite seropositivity indicators

For enteric pathogens with multiple antigens (Cryptosporidium, Giardia, Salmonella, Campylobacter), create a series of seropositivity indicators that indicate if a child was positive to either antigen.

Then bind those to the original data frame to create a seropositivity dataset for analyses.

```{r composite seropositivity indicators, eval = FALSE}
d_enteric_comps <- dl %>%
  filter(pathogen %in% c("Cryptosporidium","Giardia","Salmonella","Campylobacter")) %>%
  group_by(pathogen,childid,phase) %>%
  mutate(seropos = max(seropos)) %>%
  slice(1) %>%
  mutate(antigenf = case_when(
    antigen %in% c("cp17","cp23") ~ "Cryptosporidium Cp17 or Cp23",
    antigen %in% c("vsp3","vsp5") ~ "Giardia VSP-3 or VSP-5",
    antigen %in% c("salb","sald") ~ "Salmonella LPS B or D",
    antigen %in% c("p18","p39") ~ "Campylobacter p18 or p39"
  )) %>%
  select(clusterid,phase,arm,childid,agem,sex,dbsid,pathogen,antigenf,seropos)


```

```{r create seropositivity dataset, warning=FALSE, eval = FALSE}
d_serop <- dl %>%
  # drop pathogens w/ composite indicators
  filter(!pathogen %in% c("Cryptosporidium","Giardia","Salmonella","Campylobacter")) %>%
  # add composite indicators
  bind_rows(d_enteric_comps) %>%
  # create new factor levels that includes composite indicators
  mutate(antigenf = factor(antigenf,levels = c(
    "Campylobacter p18 or p39",
    "ETEC LTB",
    "Cholera CTB",
    "Salmonella LPS B or D",
    "Cryptosporidium Cp17 or Cp23",
    "Giardia VSP-3 or VSP-5",
   levels(d2$antigenf)[11:20]) )
         ) %>%
  # drop extra variables (MFI doesn't correspond to composite seropos so drop)
  dplyr::select(-mfi,-logmfi,-agedrop)

```



# Plot longitudinal IgG trajectories

Identify different trajectories, based on whether children experienced a 4-fold increase or decrease in IgG to above or below the seropositivity cutoff.  This is consistent with the analysis from Arnold et al. 2019, which used a definition of "incident boosting" as a 4-fold increase in IgG to above the seropositivity cutoff, and "incident waning" as a 4-fold decrease in IgG from above the seropositivity cutoff.
https://pubmed.ncbi.nlm.nih.gov/31424386/ 
https://osf.io/2j5fe/

```{r identify igg changes}

#-----------------------------
# identify incident 
# seroconversions and reversions
# in the dataset with 
# measurements separated by
# antigen (i.e., not combined responses for enterics)
# this is done to visualize
# the 4-fold changes in IgG
# which only make sense for
# individual antigens (not combined)
#-----------------------------

# group the data by child and
# use lags to identify
# time between measurements,
# sero-conversions + sero-reversions 
# between measurements
# set the first measurement to 
# missing for the incidence indicators
# (using the is.na(age_diff) to identify them)
dl2 <- dl %>%
  group_by(antigenf,childid) %>% 
  arrange(antigenf,childid,phase) %>%
  mutate(age_min  = min(agem),
         age_diff = agem - lag(agem),
         
         logmfi_lag  = lag(logmfi),
         logmfi_lead = lead(logmfi),
         logmfi_dlag  = logmfi - logmfi_lag,
         logmfi_dlead = logmfi_lead - logmfi,
         
         # incident seroconversions and reversions
         # including cumulative numbers
         seropos_lag  = lag(seropos),
         seroi = ifelse(seropos==1 & seropos_lag==0,1,0),
         seroi = ifelse(is.na(age_diff),NA,seroi),
         seroin = cumsum(ifelse(is.na(seroi),0,seroi)),
         seroin = ifelse(seroi==1,seroin,0),
         seror = ifelse(seropos==0 & seropos_lag==1,1,0),
         seror = ifelse(is.na(age_diff),NA,seror),
         serorn = cumsum(ifelse(is.na(seror),0,seror)),
         serorn = ifelse(seror==1,serorn,0)
         ) %>%
  select(
         clusterid,childid,arm,phase,
         starts_with("age"),
         antigen,antigenf,
         mfi,logmfi,logmfi_dlag,logmfi_dlead,
         serocut,seropos,
         seroi,seroin,seror,serorn,
         -logmfi_lag,-logmfi_lead,-seropos_lag)

#-----------------------------
# incident seroconversions based on a 4-fold increase in MFI
# with a second measure above the seropositivity cutoff
# incident seroreversions based on a 4-fold decrease in MFI
# with the first measure above the seropositivity cutoff
#-----------------------------
dl2 <- dl2 %>%
  mutate(seroi4fold = ifelse(logmfi_dlag>log10(4) & logmfi>log10(serocut),1,0),
         seroin4fold = cumsum(ifelse(is.na(seroi4fold),0,seroi4fold)),
         seroin4fold = ifelse(seroi4fold==1,seroin4fold,0),
         
         seror4fold=ifelse(logmfi_dlag< -log10(4) & lag(logmfi)>log10(serocut),1,0),
         serorn4fold = cumsum(ifelse(is.na(seror4fold),0,seror4fold)),
         serorn4fold = ifelse(seror4fold==1,serorn4fold,0)
         )

#-----------------------------
# create a label for different
# antibody patterns
#-----------------------------
dl2pp <- dl2 %>%
  arrange(antigenf,childid,phase) %>%
  group_by(antigenf,childid) %>%
  mutate(measnum=row_number()) %>%
  mutate(
    logmfi_chng = ifelse(logmfi_dlag>0,"Increasing","Decreasing"),
    logmfi_chng = ifelse(is.na(logmfi_chng) & logmfi_dlead>0,"Increasing",logmfi_chng),
    logmfi_chng = ifelse(is.na(logmfi_chng) & logmfi_dlead<0,"Decreasing",logmfi_chng),
    logmfi_chng = factor(logmfi_chng,levels=c("Increasing","Decreasing")),
    
    sero_chng = ifelse(lead(seroi4fold)==1,">4-fold increase to above cutoff","<4-fold change"),
    sero_chng = ifelse(lead(seror4fold)==1,">4-fold decrease from above cutoff",sero_chng),
    sero_chng = ifelse(is.na(sero_chng),lead(sero_chng),sero_chng),
    sero_chng = ifelse(is.na(sero_chng),lag(sero_chng),sero_chng),
    sero_chng = factor(sero_chng,levels=c(">4-fold increase to above cutoff",">4-fold decrease from above cutoff","<4-fold change")),
    
    sero_comp = ifelse(lead(seroi)==1 & lead(seroi4fold==1),">4-fold increase, across cutoff","<4-fold change"),
    sero_comp = ifelse(lead(seroi)==0 & lead(seroi4fold==1),">4-fold increase, above cutoff",sero_comp),
    sero_comp = ifelse(lead(seror4fold)==1,">4-fold decrease",sero_comp),
    sero_comp = factor(sero_comp,levels=c(">4-fold increase, across cutoff",">4-fold increase, above cutoff",">4-fold decrease","<4-fold change")),
    
    everseroi = max(seroi,na.rm=TRUE)
    
  ) 


```

Plot IgG levels by phase for individual children

```{r plot mfi by phase, fig.width = 8, fig.height = 12}

# custom log labels
log10labs <- c( 
  expression(10^0),
  expression(10^1),
  expression(10^2),
  expression(10^3),
  expression(10^4)
)


pmfi_long <- ggplot(data = dl2pp, aes(x = phase, y = logmfi, group = childid, color = sero_comp)) +
  facet_wrap(~antigenf,ncol=4) +
  # first draw all the lines in light grey
  geom_line(alpha=0.2,color = "gray90") +
  # then draw the lines with color 
  # (setting <4-fold change color to missing to better display the >4-fold change lines)
  geom_line(alpha=0.25) +
  geom_hline(aes(yintercept = log10(serocut)),linetype = "dashed") +
  scale_color_manual(values=c(cbpal[c(2,8,3)],NA),
                     guide=guide_legend(title="MFI change:",
                                        override.aes = list(alpha=1), nrow=2,ncol=3))+
  scale_y_continuous(breaks = 0:4, labels = log10labs) +
  scale_x_continuous(breaks=c(0,6,12,24,36)) + 
  labs(x = "study phase (months since baseline)", y = "Luminex response (MFI-bg)") +
  theme_minimal() +
  theme(
      legend.position="top",
      panel.grid.minor=element_blank(),
      panel.grid.major.y=element_blank(),
      axis.ticks.y=element_line(color="gray40")
    )

pmfi_long

# save a png file
ggsave(filename = here("figures","mordor-ab-long-trajectories.png"),device = "png",width=8,height=12)
```

# Estimate prospective rates

Estimate seroconversion rates and seroreversion rates for each pathogen. For enterics, use combined responses and seropositivity to determine seroconversion and seroreversion. For malaria, examine individual antibody responses.

## Identify incident seroconversion and seroreversion

Defined as a 4-fold increase in IgG to above seropositivity cutoff (seroconversion) or a 4-fold decrease in IgG from above seropositivity cutoff. 

```{r identify incident seroconversion and seroreversions}
#-----------------------------
# identify incident 
# seroconversions and reversions
#-----------------------------

#-----------------------------
# Identify incident boosting/waning 
# of 4-fold MFI or more. For
# incident boosting, +4fold increase
# that ends above seropositivity cutoff
# for incident waning, -4fold decrease
# that starts above seropositivity cutoff
#-----------------------------
dl3 <- dl2 %>%
  group_by(antigenf,childid) %>%
  arrange(antigenf,childid,phase) %>%
  mutate(nobs=n(),obsnum=row_number(),
         agediff=ifelse(obsnum==1,lead(agem)-agem,agem-lag(agem)),
         
    logmfi_lag  = lag(logmfi),
    logmfi_lead = lead(logmfi),
    logmfi_dlag  = logmfi - logmfi_lag,
    logmfi_dlead = logmfi_lead - logmfi,
    logmfi_d4fold = ifelse(logmfi_dlag>log10(4),1,0),
    # incident boosting based on a 4-fold increase in MFI
    # with a second measure above the seropositivity cutoff
    seroi4fold = ifelse(logmfi_dlag>log10(4) & logmfi>log10(serocut),1,0),
    seroi4fold = ifelse(is.na(logmfi_dlag),NA,seroi4fold),
    # incident waning based on a 4-fold decrease in MFI
    # with the first measure above the seropositivity cutoff
    seror4fold = ifelse(logmfi_dlag< -log10(4) & logmfi_lag>log10(serocut),1,0)
         ) %>%
  ungroup()


#-----------------------------
# create composite
# seroprevalence, boosting,
# and waning indicators
# that use information from
# multiple antigens if available
# for the enterics
#-----------------------------
dl4 <- dl3 %>%
  ungroup() %>%
  mutate(antigenf2 = antigenf,
         antigenf2 = case_when(antigen %in% c("p18","p39") ~ "Campylobacter p18 or p39",
                               antigen %in% c("salb","sald") ~ "Salmonella LPS B or D",
                               antigen %in% c("cp17","cp23") ~ "Cryptosporidium Cp17 or Cp23",
                               antigen %in% c("vsp3","vsp5") ~ "Giardia VSP-3 or VSP-5",
                               TRUE ~ as.character(antigenf)
                              ),
         antigenf2 = factor(antigenf2, levels = c(
           "Campylobacter p18 or p39",
           "ETEC LTB",
           "Cholera CTB",
           "Salmonella LPS B or D",
           "Cryptosporidium Cp17 or Cp23",
           "Giardia VSP-3 or VSP-5",
           levels(d2$antigenf)[11:20]) )
         ) %>%
  select(antigenf2,antigenf,clusterid,childid,arm,phase,agem,age_diff,seropos,seroi4fold,seror4fold) %>%
  # since incidence could fall at slightly different times across the antigens
  # for the same pathogen, use the earlier onset as the incidence measure
  arrange(antigenf2,childid,phase) %>%
  group_by(antigenf2,childid) %>%
  mutate(lagseroi=lag(seroi4fold),
         seroi4fold=ifelse(seroi4fold==1 & lagseroi==1 & !is.na(lagseroi),0,seroi4fold)) %>%
  # since incidence could fall at slightly different times across the antigens
  # for the same pathogen, use the later onset as the incident measure
  mutate(leadseror=lead(seror4fold),
         seror4fold=ifelse(seror4fold==1 & leadseror==1 & !is.na(leadseror),0,seror4fold)) %>%
  # now get the max for each pathogen at each timepoint
  group_by(antigenf2,childid,phase) %>%
  mutate(seropos=max(seropos),
         seroi4fold=max(seroi4fold),
         seror4fold=max(seror4fold)
         ) %>%
  slice(1) %>%
  select(antigenf=antigenf2,clusterid,childid,arm,phase,agem,age_diff,seropos,seroi4fold,seror4fold) %>%
  group_by(antigenf,childid) %>%
  arrange(antigenf,childid,phase) %>%
  mutate(obsnum = row_number())

#-----------------------------
# estimate time at risk
# for seroconversion and reversion
# assumed to be 1/2 of time
# between measurements
# if indivs seroconvert
# 
# create indicators of at risk
# based on incidence boosting
# and waning
# at risk if seronegative OR experienced
# a 4-fold decrease in MFI in previous period
#
# the below code is opaque, but confirmed through 
# extensive vetting and inspection that it does this:
# children are at risk of boosting if they are seronegative or
# if they experience a 4-fold decrease in MFI between the previous
# two measurements
#-----------------------------
dl5 <- dl4 %>%
  mutate(seroi4fold=ifelse(obsnum==1,0,seroi4fold),
         seror4fold=ifelse(obsnum==1,0,seror4fold),
         maxobs=max(obsnum),
         # seronegative at obs 1: at risk
         # seropositive at obs 1: not at risk
         cntr = 0,
         cntr = ifelse(seroi4fold==1 & lag(seroi4fold)==0,-1,0), # counter -1 if first +4
         cntr = ifelse(obsnum==1 & seropos==0,1,cntr), # counter +1 if seroneg&obs1
         cntr = ifelse(seror4fold==1,1,cntr), # counter +1 if seror
         cntr = ifelse(seror4fold==1 & seropos==0 & lag(cntr)==1,cntr-1,cntr),
         
         # sum counter to help with recodes below
         cntrs = cumsum(cntr),
         
         cntr = ifelse(obsnum!=maxobs & lead(cntr)==-1 & lead(cntrs)==-1,1,cntr),
         cntr = ifelse(obsnum!=maxobs & lead(cntr)==-1 & lead(cntrs)==-2,1,cntr),
         cntr = ifelse(seror4fold==1 & cntrs==2,0,cntr),

         # indicator of whether a chlid is at risk for seroconversion
         atrisk = cumsum(cntr),
         atrisk = lag(atrisk),
         
         # fix a very small number of idiosyncratic situations
         # that don't fit neatly into the above algorithm (n=5)
         atrisk = ifelse(obsnum==1,0,atrisk),
         atrisk = ifelse(obsnum > 2 & atrisk==2 | lag(atrisk==2),atrisk-1,atrisk),
         
         # now calculate person time at risk for conversion and reversion
         # use years for the unit of time at risk (so divide age_diff in months by 12)
         atriskc = atrisk,
         atriskr = 1-atrisk,
         ptc = ifelse(atriskc==1,age_diff/12,0),
         ptc = ifelse(atriskc==1 & seroi4fold==1,(age_diff/2)/12,ptc),
         ptr = ifelse(atriskr==1,age_diff/12,0),
         ptr = ifelse(atriskr==1 & seror4fold==1,(age_diff/2)/12,ptr)
         
  )


```

## Estimate prospective rates

```{r estimate prospective rates}
#-----------------------------
# estimate sero-incidence rates
# for antibody boosting and waning 
# estimate SEs with a bootstrap
#-----------------------------

#-----------------------------
# estimate incidence rates
# for each antibody
# units are episodes per child-year
#-----------------------------
rate_ests_4fold <- dl5 %>%
  group_by(antigenf) %>%
  summarize(ni=sum(seroi4fold,na.rm=T),
            nit=sum(ptc,na.rm=T),
            nr=sum(seror4fold,na.rm=T),
            nrt=sum(ptr,na.rm=T),
            .groups = "keep") %>%
  mutate(seroi=ni/nit,seror=nr/nrt)

#-----------------------------
# get bootstrap CIs
# resampling clusters with 
# replacement due to repeated
# measures
#-----------------------------
dboot <- dl5 %>%
  group_by(antigenf) %>%
  select(clusterid,antigenf,seroi4fold,seror4fold,ptc,ptr)

nreps <- 1000
ids <- unique(dboot$clusterid)
bsamp <- matrix(sample(ids,size=length(ids)*nreps,replace=TRUE),
                nrow=length(ids),ncol=nreps)
bootests <- foreach(ab=levels(dboot$antigenf),.combine=rbind) %:%
  foreach(brep=1:nreps,.combine=rbind) %dopar% {
    set.seed(brep)
    di <- dboot %>% filter(antigenf==ab)
    di <- left_join(data.frame(clusterid=bsamp[,brep]),di,by=c("clusterid")) %>%
      select(-clusterid) %>% group_by(antigenf) %>%
      summarize_all(function(x) sum(x,na.rm=TRUE))
    }

rate_cis <- bootests %>% 
  group_by(antigenf) %>%
  mutate(sero_c=seroi4fold/ptc,sero_r=seror4fold/ptr) %>%
  # restrict to finite values (some ETEC bootstrap replicates have a denominator of 0)
  summarize(seroi_lb = quantile(sero_c[is.finite(sero_c)],probs=c(0.025),na.rm=T),
            seroi_ub = quantile(sero_c[is.finite(sero_c)],probs=c(0.975),na.rm=T),
            seror_lb = quantile(sero_r[is.finite(sero_r)],probs=c(0.025),na.rm=T),
            seror_ub = quantile(sero_r[is.finite(sero_r)],probs=c(0.975),na.rm=T), 
            .groups = "keep"
            )

rate_ests_4fold <- left_join(rate_ests_4fold,rate_cis,by="antigenf") %>%
  select(antigenf,ni,nit,starts_with("seroi"),nr,nrt,starts_with("seror"))

```

Confirm bootstrap distributions of the rates are smooth and reasonable
```{r check boot distributions, fig.width = 8, fig.height = 12}
bsum <- bootests %>% 
  group_by(antigenf) %>%
  mutate(sero_c=seroi4fold/ptc,sero_r=seror4fold/ptr)

ggplot(data=bsum,aes(x=sero_c)) + geom_density() + facet_wrap(~antigenf,ncol=2,scales="free") + labs(title = "Seroconversion") + theme_minimal()

ggplot(data=bsum,aes(x=sero_r)) + geom_density() + facet_wrap(~antigenf,ncol=2,scales="free") + labs(title = "Seroreversion") + theme_minimal()

```

## Table of results

```{r seroconversion rate table}
rate_ests_4fold %>%
  select(antigenf,nit,ni,seroi,seroi_lb,seroi_ub,nrt,nr,seror,seror_lb,seror_ub) %>%
  knitr::kable(digits=2,
             caption="Longitudinal incidence rates of 4-fold antibody boosting and waning per child year, MORDOR Niger, 2015-2018.",
             col.names = c("Pathogen, antigen(s)","Years at risk","n events","Incidence per year","min95","max95","Years at risk","n events","Incidence per year","min95","max95"),
             row.names = FALSE) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped"),full_width = TRUE) %>%
  kableExtra::add_header_above(c(" " = 1, "Seroconversion (IgG boosting) *" = 5, "Seroreversion (IgG waning) †" = 5)) %>% 
  kableExtra::group_rows("Enterics and strep", 1,7) %>%
  kableExtra::group_rows("Malaria", 8, 16) %>%
  kableExtra::footnote(symbol = c("Incident seroconversion defined by a 4-fold increase in IgG levels (MFI-bg) to a final level above the seropositivity cutoff.", "Incident seroreversion defined by a 4-fold decrease in IgG levels from a starting level above the seropositivy cutoff.")
           )

```

## Save longitudinal rate estimates for other comparisons

Save longitudinal rates pooled over arms (total population)

```{r save long rates}
write_csv(rate_ests_4fold,here("data","mordor-ab-longitudinal-rate-ests.csv"))
```

# Estimate rates by arm

Estimate prospective incidence rates and incidence rate ratio by arm as a sensitivity analysis for the primary analysis that estimates the hazard ratio from a current status analysis of age-structured seroprevalence data.

```{r estimate prospective rates by arm}
#-----------------------------
# estimate sero-incidence rates
# for antibody boosting and waning 
# by arm
# estimate SEs with a bootstrap
#-----------------------------

#-----------------------------
# estimate incidence rates
# for each antibody
# units are episodes per child-year
#-----------------------------
rate_ests_by_arm <- dl5 %>%
  group_by(antigenf,arm) %>%
  summarize(ni=sum(seroi4fold,na.rm=T),
            nit=sum(ptc,na.rm=T),
            nr=sum(seror4fold,na.rm=T),
            nrt=sum(ptr,na.rm=T),
            .groups = "keep") %>%
  mutate(seroi=ni/nit,seror=nr/nrt)

#-----------------------------
# get bootstrap CIs
# resampling clusters with 
# replacement due to repeated
# measures
#-----------------------------
dboot <- dl5 %>%
  group_by(antigenf,arm) %>%
  select(clusterid,antigenf,arm,seroi4fold,seror4fold,ptc,ptr)

nreps <- 1000
ids <- unique(dboot$clusterid)
bsamp <- matrix(sample(ids,size=length(ids)*nreps,replace=TRUE),
                nrow=length(ids),ncol=nreps)
bootests <- foreach(ab=levels(dboot$antigenf),.combine=rbind) %:%
  foreach(brep=1:nreps,.combine=rbind) %dopar% {
    set.seed(brep)
    di <- dboot %>% filter(antigenf==ab)
    di <- left_join(data.frame(clusterid=bsamp[,brep]),di,by=c("clusterid")) %>%
      select(-clusterid) %>% group_by(antigenf,arm) %>%
      summarize_all(function(x) sum(x,na.rm=TRUE)) %>%
      mutate(brep = brep)
    }

# estimate bootstrap 95% CIs for rates
rate_cis_by_arm <- bootests %>% 
  group_by(antigenf,arm) %>%
  mutate(sero_c = seroi4fold/ptc,
         sero_r = seror4fold/ptr) %>%
  # restrict to finite values (some ETEC bootstrap replicates have a denominator of 0)
  summarize(seroi_lb = quantile(sero_c[is.finite(sero_c)],probs=c(0.025),na.rm=T),
            seroi_ub = quantile(sero_c[is.finite(sero_c)],probs=c(0.975),na.rm=T),
            seror_lb = quantile(sero_r[is.finite(sero_r)],probs=c(0.025),na.rm=T),
            seror_ub = quantile(sero_r[is.finite(sero_r)],probs=c(0.975),na.rm=T), 
            .groups = "keep"
            )

rate_ests_by_arm <- left_join(rate_ests_by_arm,rate_cis_by_arm,by=c("antigenf","arm")) %>%
  select(antigenf,arm,ni,nit,starts_with("seroi"),nr,nrt,starts_with("seror"))

# Estimate bootstrapped 95% CI for IRR
rate_boot_p <- bootests %>% 
  filter(arm=="placebo") %>% 
  select(antigenf, brep,
         seroi4fold_p = seroi4fold, ptc_p = ptc,
         seror4fold_p = seror4fold, ptr_p = ptr)

rate_boot_irr <- bootests %>% 
  filter(arm=="azithro") %>%
  select(antigenf, brep,
         seroi4fold_a = seroi4fold, ptc_a = ptc,
         seror4fold_a = seror4fold, ptr_a = ptr) %>%
  left_join(rate_boot_p, by = c("antigenf","brep")) %>%
  mutate(irate_azithro = seroi4fold_a / ptc_a,
         irate_placebo = seroi4fold_p / ptc_p,
         rrate_azithro = seror4fold_a / ptr_a,
         rrate_placebo = seror4fold_p / ptr_p,
         irri = irate_azithro / irate_placebo)

irr_cis <- rate_boot_irr %>%
  group_by(antigenf) %>%
  summarize(irr_lb = quantile(irri[is.finite(irri)],probs = c(0.025)),
            irr_ub = quantile(irri[is.finite(irri)],probs = c(0.975)), 
            .groups = "keep")

irr_ests_p <- rate_ests_by_arm %>%
  ungroup() %>%
  filter(arm=="placebo") %>%
  select(antigenf,ni_p = ni, nit_p = nit, seroi_p = seroi, seroi_lb_p = seroi_lb, seroi_ub_p = seroi_ub)
irr_ests <- rate_ests_by_arm %>%
  ungroup() %>%
  filter(arm == "azithro") %>%
  select(antigenf, ni_a = ni, nit_a = nit, seroi_a = seroi, seroi_lb_a = seroi_lb, seroi_ub_a = seroi_ub) %>%
  left_join(irr_ests_p, by = "antigenf") %>%
  mutate(irr = seroi_a / seroi_p) %>%
  left_join(irr_cis, by = "antigenf")

```

## Summary table
```{r summary irr table}

knitr::kable(irr_ests,
             caption = "Seroconversion rates estimated longitudinally among children in MORDOR Niger, 2015 - 2018.",
             col.names = c("Pathogen, antigen", "N events","Person-Years","Rate per year","min 95", "max 95","N events","Person-Years","Rate per year","min 95", "max 95", "IRR", "min 95", "max 95"), 
             digits = 2,
             align = "lrrcccrrcccccc") %>%
  kable_styling(bootstrap_options = c("striped","condensed"),full_width = TRUE) %>%
  add_header_above(c(" " = 1, "Azithromycin" = 5,  "Placebo" = 5, " " = 3)) %>%
  kableExtra::group_rows(group_label = "Enterics and strep", start_row = 1, end_row = 8) %>%
  kableExtra::group_rows(group_label = "Malaria", start_row = 8, end_row = 16) 

```


## Save longitudinal rate estimates by arm

Save longitudinal rates by arm for other comparisons

```{r save long irr ests}
write_csv(irr_ests,here("data","mordor-ab-longitudinal-irr-ests.csv"))
```

# Session Info
```{r session info}
sessionInfo()
```


