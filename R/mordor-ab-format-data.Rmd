---
title: "Analysis of multiplex antibody endpoints in the MORDOR Niger trial"
subtitle: "Format data for analysis"
author: "Ben Arnold ben.arnold@ucsf.edu"
date: "updated: `r Sys.time()`"
output: 
  html_document:
    theme: default
    highlight: haddock
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: true
---

# Preamble

```{r preamble}
library(here)
here()
#----------------------------
# source the config file
#----------------------------
source(here("R","mordor-ab-Config.R"))
```

# Format the MBA antibody data

```{r load antibody data}
#-------------------------------
# load the raw MBA data sent from
# Diana Martin at CDC
#-------------------------------
d <- read_csv("~/Box sync/mordor-ab/data/untouched/mba/MORDOR MBA Raw Data Compiled 100219.csv")


#-------------------------------
# a couple of the DBS IDs include
# "Rerun" in the field. Cut this
# out of the ID
# trim all whitespace from the IDs
# just in case
#-------------------------------
d$description[grep(" Rerun", d$description)]
d$description <- gsub(" Rerun","",d$description)
d$description <- str_trim(d$description)

#-------------------------------
# pivot longer and create formatted
# antigen names and pathogen names
# careful / the antigen list
# and labels are in a specific order
#-------------------------------
antigens <- c("cp17","cp23",
              "vsp3","vsp5",
              "salb","sald",
              "p18","p39",
              "etec","ctb",
              "speb",
              
              "hrp2","csp","glurp","lsa1","ama","pfmsp1",
              "pvmsp1","pomsp1","pmmsp1",
              
              "pgp3","ct694",
              "nie",
              "gst"
              )
antigen_labs <- c(
  "Cryptosporidium Cp27",
  "Crptyosporidium Cp23",
  "Giardia VSP-3",
  "Giardia VSP-5",
  "Salmonella LPS B",
  "Salmonella LPS D",
  "Campylobacter p18",
  "Campylobacter p39",
  "ETEC LTB",
  "Cholera CTB",
  "Streptococcus A",
  "P. falciparum HRP2",
  "P. falciparum CSP",
  "P. falciparum GLURP-Ro",
  "P. falciparum LSA1",
  "P. falciparum AMA",
  "P. falciparum MSP-1",
  "P. vivax MSP-1",
  "P. ovale MSP-1",
  "P. malariae MSP-1",
  "Trachoma Pgp3",
  "Trachoma CT694",
  "Strongyloides NIE",
  "GST negative control"
)

d2 <- d %>%
  rename(dbsid=description) %>%
  pivot_longer(cols = c(-type,-well,-dbsid),
               names_to = "antigen", 
               values_to = "mfi") %>%
  mutate(antigenf = factor(antigen, levels=antigens, labels = antigen_labs)) %>%
  mutate(pathogen = case_when(
    antigen %in% c("cp17","cp23") ~ "Cryptosporidium",
    antigen %in% c("vsp3","vsp5") ~ "Giardia",
    antigen %in% c("salb","sald") ~ "Salmonella",
    antigen %in% c("p18","p39") ~ "Campylobacter",
    antigen %in% c("etec") ~ "ETEC",
    antigen %in% c("ctb") ~ "Cholera",
    antigen %in% c("speb") ~ "Streptococcus",
    antigen %in% c("hrp2","csp","glurp","lsa1","ama","pfmsp1") ~ "P. falciparum",
    antigen %in% c("pvmsp1") ~ "P. vivax",
    antigen %in% c("pomsp1") ~ "P. ovale",
    antigen %in% c("pmmsp1") ~ "P. malariae",
    antigen %in% c("nie") ~ "Strongyloides",
    antigen %in% c("pgp3","ct694") ~ "Trachoma",
    antigen %in% c("gst") ~ "Neg control"
  ) ) %>%
    mutate(pathogen = factor(pathogen,levels=c("Cryptosporidium","Giardia","Salmonella","Campylobacter","ETEC","Cholera","Streptococcus","P. falciparum","P. vivax","P. ovale","P. malariae","Strongyloides","Trachoma","Neg control"))
           ) %>%
  select(dbsid,type,well,pathogen,antigen,antigenf,mfi)
        
```

Summarize the data
```{r summarize mba data}
summary(d2)

```

# Format morbidity data

Read in the final morbidity dataset shared by Jermey Keenan in December 2019.  Victoria Li originally wrote the code below, spliced into this Rmd file.

```{r format morbidity}
#-------------------------------
# read in the full morbidity file
#-------------------------------
md <- read_csv("~/Box sync/mordor-ab/data/untouched/morbidity/MORDOR-Morbidity-merged-20Mar2019.csv",
                      col_types = cols(code_bspot_ = col_character(),
                                       arm = col_character(),
                                       txlabelgwu = col_character()))


#-------------------------------
# Select relevant variables 
# rename variables to be more
# convenient
#-------------------------------
md2 <- md %>% 
  select(dbsid=code_bspot_,
         clname = gwu,
         gwunotes_,
         masterphase,
         masterperson_mcd,
         arm,
         txlabelgwu,
         studypop = studypop_,
         phase = phaseidmep,
         sex = gendermcd_,
         pf_thicksmear = thicksmear_cons_bsmear_,
         pf_density = officialdensity_bsmear_,
         pf_gameto = gameto_bsmear_,
         contains("age")
         ) %>% 
  mutate(sex = factor(sex,levels=c("FEMALE","MALE"),labels = c("female","male")),
         dbsid = str_trim(dbsid)
         )
  
#-------------------------------
# filter out observations with
# gwunotes_ not missing (indicates a problem observation)
#
# create a community ID variable
# that isn't based on names
#-------------------------------
md3 <- md2 %>% 
  filter(is.na(gwunotes_)) %>%
  select(-gwunotes_) %>%
  mutate(cluster_name = str_to_upper(clname))
md3$clusterid <- paste0("C",group_indices(md3,cluster_name))
  
#-------------------------------
# there are many age varibles
# do some reconciliation to
# harmonize and create a single
# child age
#
# TO BE UPDATED WITH INPUT FROM
# JEREMY
#
# use agecc_mcd as the reference
# age, but for children with
# (a) missing values
# (b) values < 0
# (c) values > 59
# replace it with values from
# agemosblood_
#-------------------------------
md4 <- md3 %>%
  mutate(agem = agecc_mcd,
         agem = ifelse(is.na(agem),agemosblood_,agem),
         agem = ifelse(agem<0 & agemosblood_ >=0,agemosblood_, agem),
         agem = ifelse(agem>59 & agemosblood_ <=agem,agemosblood_, agem))
```


# Merge DBS with morbidity data

Merge the two datasets

```{r merge antibody and morbidity data}

#-------------------------------
# join to the DBS measures
#-------------------------------
d3 <- d2 %>%
  left_join(md4,by = "dbsid")


#-------------------------------
# There are 53 / 5699 (0.9%) 
# of the DBS specimen results
# that do not match to the
# morbidity file
# print the DBS IDs and 
# then put to the side for now
#-------------------------------
dbs_nomatch <- d3 %>%
  filter(is.na(cluster_name)) %>%
  select(dbsid,antigen,mfi) %>%
  pivot_wider(id_cols = dbsid, names_from = "antigen", values_from = "mfi")

d4 <- d3 %>%
  filter(!is.na(cluster_name))

write_csv(dbs_nomatch,"~/box sync/mordor-ab/data/temp/mordor-ab-dbs-nomatch.csv")


```


# Re-randomize for masking

Re-randomize community assignments. The morbidity file includes masked assignments (sun, moon) but they are not re-randomized. Save the real assignments on the side and use re-randomized labels until the main analyses are all finished. Then, we will unmask by updating this script to merge in the real assignments.

```{r re-randomize community assignments}
#-------------------------------
# store the real treatment
# assignments, put to the side
#-------------------------------
comd <- d4 %>%
  select(clusterid,arm) %>%
  group_by(clusterid) %>%
  slice(1)
write_csv(comd,"~/box sync/mordor-ab/data/final/mordor-ab-tr.csv")

#-------------------------------
# create a set of re-randomized
# treatment labels
#-------------------------------
set.seed(12345)
comd_rr <- comd %>%
  select(clusterid) %>%
  ungroup() %>%
  mutate(arm = sample(rep(c("sun","moon"),15),size=30,replace=FALSE))

#-------------------------------
# merge re-randomized (shuffled)
# labels to the antibody data
#-------------------------------
d5 <- d4 %>%
  select(-arm) %>%
  left_join(comd_rr,by="clusterid") %>%
  mutate(arm = factor(arm,levels=c("sun","moon")))

```

# Save analysis data

```{r save analysis data}
#-------------------------------
# select variables, summarize
# and save data
#-------------------------------
d6 <- d5 %>%
  select(clusterid,phase,arm,agem,sex,pf_thicksmear,pf_density,pf_gameto,dbsid,type,well,pathogen,antigen,antigenf,mfi)

summary(d6)
write_rds(d6,"~/box sync/mordor-ab/data/final/mordor-ab-analysis.rds")
write_csv(d6,"~/box sync/mordor-ab/data/final/mordor-ab-analysis.csv")

```

# Session Info
```{r session info}
sessionInfo()
```


